name: Publish to crates.io

on:
  # Trigger on GitHub releases
  release:
    types: [published]

  # Allow manual triggering
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-run mode (test without publishing)'
        required: false
        default: false
        type: boolean
      skip_tests:
        description: 'Skip running tests before publishing'
        required: false
        default: false
        type: boolean

env:
  CARGO_TERM_COLOR: always

jobs:
  # æ™ºèƒ½å‘å¸ƒæ‰€æœ‰åŒ…
  publish-all:
    name: Smart publish to crates.io
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Get current version
        id: version
        run: |
          # ä»Ž workspace èŽ·å–ç‰ˆæœ¬
          CURRENT_VERSION=$(grep '^version = ' Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_VERSION"

      - name: Smart dependency update
        run: |
          CURRENT_VERSION="${{ steps.version.outputs.current_version }}"
          echo "Updating internal dependencies to version $CURRENT_VERSION"

          # ä¸´æ—¶æ›´æ–°ä¾èµ–ç‰ˆæœ¬ä»¥æ”¯æŒå‘å¸ƒ
          # è¿™äº›æ›´æ”¹åªåœ¨ CI ä¸­ç”Ÿæ•ˆï¼Œä¸ä¼šæäº¤åˆ°ä»“åº“

          # æ£€æŸ¥ purger-core æ˜¯å¦å·²å‘å¸ƒ
          CORE_EXISTS=$(curl -s "https://crates.io/api/v1/crates/purger-core" | jq -r ".versions[] | select(.num == \"$CURRENT_VERSION\") | .num" 2>/dev/null || echo "")

          if [[ -n "$CORE_EXISTS" ]]; then
            echo "âœ… purger-core $CURRENT_VERSION already exists, updating dependencies"
            # æ›´æ–°æ‰€æœ‰ä¾èµ–åˆ°å·²å‘å¸ƒçš„ç‰ˆæœ¬
            sed -i "s/purger-core = { version = \"[^\"]*\"/purger-core = { version = \"$CURRENT_VERSION\"/g" purger-cli/Cargo.toml
            sed -i "s/purger-core = { version = \"[^\"]*\"/purger-core = { version = \"$CURRENT_VERSION\"/g" purger-gui/Cargo.toml
            sed -i "s/purger-core = { version = \"[^\"]*\"/purger-core = { version = \"$CURRENT_VERSION\"/g" Cargo.toml
          else
            echo "ðŸ“¦ purger-core $CURRENT_VERSION not published yet, will publish it first"
          fi

      - name: Pre-publish checks
        if: ${{ !inputs.skip_tests }}
        run: |
          echo "Running pre-publish checks..."
          cargo fmt --all -- --check
          cargo clippy --workspace --all-targets --all-features -- -D warnings

          # åªå¯¹å·²å‘å¸ƒä¾èµ–çš„åŒ…è¿è¡Œæµ‹è¯•
          CURRENT_VERSION="${{ steps.version.outputs.current_version }}"
          CORE_EXISTS=$(curl -s "https://crates.io/api/v1/crates/purger-core" | jq -r ".versions[] | select(.num == \"$CURRENT_VERSION\") | .num" 2>/dev/null || echo "")

          if [[ -n "$CORE_EXISTS" ]]; then
            echo "Running full test suite..."
            cargo test --workspace --all-features
          else
            echo "Running core tests only..."
            cargo test -p purger-core --all-features
          fi

      - name: Smart publish packages
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          CURRENT_VERSION="${{ steps.version.outputs.current_version }}"

          # æ£€æŸ¥ token
          if [[ "${{ inputs.dry_run }}" != "true" ]] && [[ -z "$CARGO_REGISTRY_TOKEN" ]]; then
            echo "âŒ Error: CARGO_REGISTRY_TOKEN is not set"
            echo "Please add your crates.io API token to GitHub Secrets"
            echo "Go to: Repository Settings â†’ Secrets and variables â†’ Actions"
            echo "Add a secret named 'CARGO_REGISTRY_TOKEN' with your crates.io API token"
            exit 1
          fi

          # æ£€æŸ¥åŒ…æ˜¯å¦å·²å‘å¸ƒçš„å‡½æ•°
          check_published() {
            local crate_name=$1
            local version=$2
            curl -s "https://crates.io/api/v1/crates/$crate_name" | jq -r ".versions[] | select(.num == \"$version\") | .num" 2>/dev/null || echo ""
          }

          # å‘å¸ƒåŒ…çš„å‡½æ•°
          publish_package() {
            local package_name=$1
            local package_dir=$2

            echo "ðŸ“¦ Processing $package_name..."

            # æ£€æŸ¥æ˜¯å¦å·²å‘å¸ƒ
            if [[ -n "$(check_published "$package_name" "$CURRENT_VERSION")" ]]; then
              echo "âœ… $package_name $CURRENT_VERSION already published, skipping"
              return 0
            fi

            if [[ "${{ inputs.dry_run }}" == "true" ]]; then
              echo "ðŸ§ª Dry run: Would publish $package_name"
              if [[ -n "$package_dir" ]]; then
                cd "$package_dir"
                cargo publish --dry-run
                cd ..
              else
                cargo publish --dry-run
              fi
            else
              echo "ðŸ“¦ Publishing $package_name..."
              if [[ -n "$package_dir" ]]; then
                cd "$package_dir"
                cargo publish --token "$CARGO_REGISTRY_TOKEN"
                cd ..
              else
                cargo publish --token "$CARGO_REGISTRY_TOKEN"
              fi

              echo "â³ Waiting 60 seconds for crates.io propagation..."
              sleep 60
            fi
          }

          # æŒ‰ä¾èµ–é¡ºåºå‘å¸ƒåŒ…
          echo "ðŸš€ Starting smart package publishing for version $CURRENT_VERSION"

          # 1. å‘å¸ƒ purger-core (æ— ä¾èµ–)
          publish_package "purger-core" "purger-core"

          # 2. æ›´æ–°ä¾èµ–ç‰ˆæœ¬ï¼ˆå¦‚æžœ core åˆšåˆšå‘å¸ƒï¼‰
          if [[ "${{ inputs.dry_run }}" != "true" ]]; then
            echo "ðŸ”„ Updating dependency versions after core publication..."
            sed -i "s/purger-core = { version = \"[^\"]*\"/purger-core = { version = \"$CURRENT_VERSION\"/g" purger-cli/Cargo.toml
            sed -i "s/purger-core = { version = \"[^\"]*\"/purger-core = { version = \"$CURRENT_VERSION\"/g" purger-gui/Cargo.toml
            sed -i "s/purger-core = { version = \"[^\"]*\"/purger-core = { version = \"$CURRENT_VERSION\"/g" Cargo.toml
          fi

          # 3. å‘å¸ƒ purger-cli (ä¾èµ– purger-core)
          publish_package "purger-cli" "purger-cli"

          # 4. å‘å¸ƒ purger-gui (ä¾èµ– purger-core)
          publish_package "purger-gui" "purger-gui"

          # 5. å‘å¸ƒ purger (ä¾èµ– purger-core)
          publish_package "purger" ""

          echo "âœ… Smart publishing completed!"

      - name: Summary
        run: |
          echo "## ðŸš€ Publishing Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ steps.version.outputs.current_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Mode:** ${{ inputs.dry_run == 'true' && 'ðŸ§ª Dry run' || 'âœ… Live publish' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
